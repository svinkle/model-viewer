{"version":3,"file":"ar.js","sourceRoot":"","sources":["../../src/features/ar.js"],"names":[],"mappings":"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","sourcesContent":["/*\n * Copyright 2018 Google Inc. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {IS_AR_CANDIDATE, IS_IOS, IS_AR_QUICKLOOK_CANDIDATE} from '../constants.js';\nimport {$renderer, $scene} from '../model-viewer-base.js';\nimport {openIOSARQuickLook} from '../utils.js';\nimport {deserializeUrl} from '../utils.js';\n\nconst $enterARElement = Symbol('enterARElement');\nconst $enterARWithQuickLook = Symbol('enterARWithQuickLook');\nconst $enterARWithWebXR = Symbol('enterARWithWebXR');\n\nexport const ARMixin = (ModelViewerElement) => {\n  return class extends ModelViewerElement {\n    static get properties() {\n      return {\n        ...super.properties,\n        unstableWebxr: {type: Boolean, attribute: 'unstable-webxr' },\n        iosSrc: {type: deserializeUrl, attribute: 'ios-src'}\n      };\n    }\n\n    get canActivateAR() {\n      return window.getComputedStyle(this[$enterARElement]).display !== 'none';\n    }\n\n    constructor() {\n      super();\n\n      // TODO: Add this to the shadow root as part of this mixin's\n      // implementation:\n      this[$enterARElement] = this.shadowRoot.querySelector('.enter-ar');\n\n      this[$enterARElement].addEventListener('click', e => {\n        e.preventDefault();\n        this.enterAR();\n      });\n\n      const renderer = this[$renderer];\n      const scene = this[$scene];\n      const onFullscreenchange = () => {\n        if (document.fullscreenElement !== this &&\n            renderer.presentedScene === scene) {\n          try {\n            renderer.stopPresenting();\n          } catch (error) {\n            console.warn('Unexpected error while stopping AR presentation');\n            console.error(error);\n          }\n        }\n      };\n\n      document.addEventListener('fullscreenchange', onFullscreenchange);\n    }\n\n    /**\n     * Enables the AR\n     */\n    enterAR() {\n      if (IS_IOS) {\n        this[$enterARWithQuickLook]();\n      } else if (IS_AR_CANDIDATE) {\n        this[$enterARWithWebXR]();\n      }\n    }\n\n    async [$enterARWithQuickLook]() {\n      openIOSARQuickLook(this.iosSrc);\n    }\n\n    async [$enterARWithWebXR]() {\n      const renderer = this[$renderer];\n\n      console.log('Attempting to enter fullscreen and present in AR...');\n\n      try {\n        const enterFullscreen = this.requestFullscreen();\n\n        try {\n          const outputElement = await renderer.present(this[$scene]);\n          this.shadowRoot.appendChild(outputElement);\n          await enterFullscreen;\n        } catch (error) {\n          console.warn('Error while trying to present to AR');\n          console.error(error);\n          await enterFullscreen;\n          if (document.fullscreenElement === this) {\n            console.warn('Exiting fullscreen under dire circumstances');\n            document.exitFullscreen();\n          }\n        }\n      } catch (error) {\n        console.error(error);\n        console.warn('AR will not activate without fullscreen permission');\n      }\n    }\n\n    async update(changedProperties) {\n      super.update(changedProperties);\n\n      if (!changedProperties.has('unstableWebxr') && !changedProperties.has('iosSrc')) {\n        return;\n      }\n\n      const canShowButton = this.unstableWebxr && IS_AR_CANDIDATE;\n      const iosCandidate = IS_IOS && IS_AR_QUICKLOOK_CANDIDATE && this.iosSrc != null;\n      const renderer = this[$renderer];\n\n      // On iOS, always enable the AR button. On non-iOS,\n      // see if AR is supported, and if so, display the button after\n      // an XRDevice has been initialized\n      if (iosCandidate ||\n          (canShowButton && await renderer.supportsPresentation())) {\n        this[$enterARElement].style.display = 'block';\n      } else {\n        this[$enterARElement].style.display = 'none';\n      }\n    }\n  };\n}\n"]}